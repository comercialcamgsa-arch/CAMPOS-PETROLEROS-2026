let map;

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 20.0, lng: -92.0 },
    zoom: 6
  });

  // Carga GeoJSON desde la carpeta geojson
  map.data.loadGeoJson('geojson/mapa_pozos_puertos.geojson');

  // Estilo inicial
  map.data.setStyle(feature => getIcon(feature));

  // InfoWindow al hacer clic
  const infoWindow = new google.maps.InfoWindow();
  map.data.addListener('click', event => {
    let content = '';
    if (event.feature.getProperty('name')) content += `<strong>${event.feature.getProperty('name')}</strong><br>`;
    if (event.feature.getProperty('operator')) {
      content += `Operador: ${event.feature.getProperty('operator')}<br>`;
      content += `Aceite: ${event.feature.getProperty('aceite_bpd') || 'N/A'} BPD<br>`;
      content += `Gas: ${event.feature.getProperty('gas_mmpcd') || 'N/A'} MMPCD`;
    }
    if (event.feature.getProperty('role')) content += `Rol: ${event.feature.getProperty('role')}`;
    infoWindow.setContent(content);
    infoWindow.setPosition(event.latLng);
    infoWindow.open(map);
  });

  // Eventos de filtro
  document.querySelectorAll('.filter').forEach(cb => {
    cb.addEventListener('change', applyFilters);
  });
}

function getIcon(feature) {
  const op = feature.getProperty('operator');
  const puerto = feature.getProperty('role');

  let color = "#888888", scale = 6, path = google.maps.SymbolPath.CIRCLE;

  if (puerto) { color = "#FFD700"; scale = 10; path = google.maps.SymbolPath.BACKWARD_CLOSED_ARROW; }
  else if (op === "Pemex") color = "#006341";
  else if (op === "Shell") color = "#0033A0";
  else if (op === "Woodside") color = "#FF8C00";
  else if (op === "Fieldwood") color = "#FF0000";
  else if (op === "Chevron") color = "#1E90FF";

  return { path, scale, fillColor: color, fillOpacity: 0.8, strokeWeight: 1, strokeColor: "#000" };
}

function applyFilters() {
  const active = Array.from(document.querySelectorAll('.filter:checked')).map(cb => cb.value);
  map.data.forEach(feature => {
    const op = feature.getProperty('operator');
    const puerto = feature.getProperty('role') ? 'Puertos' : null;
    const visible = (puerto && active.includes('Puertos')) || (op && active.includes(op));
    map.data.overrideStyle(feature, { visible, icon: getIcon(feature) });
  });
}

google.maps.event.addDomListener(window, 'load', initMap);
